{% extends "base.html" %}

{% block title %}Pickup Map - Waste Care{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS - Using cdnjs for better reliability -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        z-index: 1;
        background-color: #e0e0e0;
    }
    
    /* Ensure Leaflet tiles load properly */
    .leaflet-container {
        height: 100%;
        width: 100%;
        border-radius: 15px;
    }
    
    .map-container {
        position: relative;
        margin-bottom: 2rem;
    }
    
    .map-controls {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
    }
    
    .filter-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .filter-item {
        flex: 1;
        min-width: 200px;
    }
    
    .legend-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
        padding: 0.5rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .legend-item:hover {
        background: rgba(0, 0, 0, 0.05);
        transform: translateX(5px);
    }
    
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
    }
    
    .stat-box {
        background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }
    
    .stat-box:hover {
        transform: translateY(-5px);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 0.25rem;
    }
    
    .stat-label {
        font-size: 0.875rem;
        opacity: 0.9;
    }
    
    /* Custom Leaflet Popup Styles */
    .leaflet-popup-content-wrapper {
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }
    
    .popup-content {
        padding: 0.5rem;
    }
    
    .popup-header {
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 0.75rem;
        color: var(--primary);
    }
    
    .popup-detail {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    
    .popup-detail i {
        width: 20px;
        color: var(--primary);
    }
    
    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 15px;
        z-index: 1000;
    }
    
    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-6">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="floating-card p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="gradient-text mb-2" style="font-size: 2.5rem; font-weight: 800;">
                            <i class="fas fa-map-marked-alt me-3"></i>Pickup Location Map
                        </h1>
                        <p class="text-muted mb-2 fs-5">Track garbage pickup locations in Almeria, Biliran</p>
                        <div class="d-inline-flex align-items-center gap-2">
                            <span class="badge bg-primary">
                                <i class="fas fa-map-pin me-1"></i>Almeria Only
                            </span>
                            <span class="badge bg-info">
                                <i class="fas fa-lock me-1"></i>Map Restricted to Service Area
                            </span>
                        </div>
                    </div>
                    <div class="d-flex gap-3">
                        <a href="{% url 'core:pickup_create' %}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Schedule Pickup
                        </a>
                        <a href="{% url 'core:dashboard' %}" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="map-controls">
                <h5 class="mb-3 fw-bold"><i class="fas fa-filter me-2"></i>Filters</h5>
                <div class="filter-group">
                    <div class="filter-item">
                        <label class="form-label fw-semibold">Status</label>
                        <select id="statusFilter" class="form-select">
                            <option value="">All Statuses</option>
                            {% for value, label in status_choices %}
                            <option value="{{ value }}" {% if value == status_filter %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-item">
                        <label class="form-label fw-semibold">Date</label>
                        <input type="date" id="dateFilter" class="form-control" value="{{ date_filter }}">
                    </div>
                    <div class="filter-item d-flex align-items-end">
                        <button id="applyFilters" class="btn btn-primary w-100">
                            <i class="fas fa-search me-2"></i>Apply Filters
                        </button>
                    </div>
                    <div class="filter-item d-flex align-items-end">
                        <button id="clearFilters" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-times me-2"></i>Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Info Alert -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info border-0 d-flex align-items-center" style="background: linear-gradient(135deg, rgba(13, 110, 253, 0.1), rgba(13, 202, 240, 0.1));">
                <i class="fas fa-info-circle fa-2x me-3 text-info"></i>
                <div>
                    <strong>Service Area Notice:</strong> This map displays pickup locations within <strong>Almeria, Biliran</strong> only. 
                    The map is restricted to our service area and cannot be panned outside these boundaries.
                </div>
            </div>
        </div>
    </div>

    <!-- Map and Legend -->
    <div class="row">
        <div class="col-lg-9">
            <div class="map-container">
                <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                    <div class="spinner"></div>
                </div>
                <div id="map"></div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="legend-card">
                <h5 class="mb-3 fw-bold"><i class="fas fa-info-circle me-2"></i>Legend</h5>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FFA500;"></div>
                    <span>Requested</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4A90E2;"></div>
                    <span>Scheduled</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FFD700;"></div>
                    <span>In Progress</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #28A745;"></div>
                    <span>Completed</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #DC3545;"></div>
                    <span>Cancelled</span>
                </div>
                
                <hr class="my-4">
                
                <div id="mapStats" class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-number" id="totalMarkers">0</div>
                        <div class="stat-label">Total Locations</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS - Using cdnjs for better reliability -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
// Initialize map after page loads and Leaflet is ready
window.addEventListener('load', function() {
    console.log('Page loaded, initializing map...');
    console.log('Leaflet available:', typeof L !== 'undefined');
    
    // Check if Leaflet is loaded
    if (typeof L === 'undefined') {
        console.error('Leaflet library not loaded!');
        document.getElementById('map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; padding: 2rem; text-align: center;"><i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i><h4>Map Library Failed to Load</h4><p class="text-muted">The map library could not be loaded from the CDN. This might be due to:</p><ul class="text-left" style="max-width: 400px;"><li>Internet connection issues</li><li>Browser blocking external scripts</li><li>Firewall or antivirus blocking</li></ul><button class="btn btn-primary mt-3" onclick="location.reload()"><i class="fas fa-sync me-2"></i>Retry</button></div>';
        return;
    }
    
    try {
        // Define strict bounds for Almeria, Biliran only
        const almeriaBounds = L.latLngBounds(
            L.latLng(11.5800, 124.3200), // Southwest corner
            L.latLng(11.7100, 124.4700)  // Northeast corner
        );
        
        // Initialize map centered on Almeria with strict bounds
        const map = L.map('map', {
            center: [11.6447, 124.3931],
            zoom: 14,
            minZoom: 13,
            maxZoom: 18,
            maxBounds: almeriaBounds,
            maxBoundsViscosity: 1.0  // Makes bounds completely solid - cannot drag outside
        });
        console.log('Map initialized successfully with Almeria bounds');
        
        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19,
        }).addTo(map);
        console.log('Tile layer added');
        
        // Force map to invalidate size (fixes display issues)
        setTimeout(function() {
            map.invalidateSize();
            console.log('Map size invalidated');
        }, 100);
        
        // Store markers
        let markers = [];
        let markerGroup = L.layerGroup().addTo(map);
    
    // Function to create custom icon based on status
    function createCustomIcon(color) {
        return L.divIcon({
            className: 'custom-marker',
            html: `<div style="background-color: ${color}; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15],
            popupAnchor: [0, -15]
        });
    }
    
    // Function to get status badge HTML
    function getStatusBadge(status, statusDisplay) {
        const colors = {
            'requested': '#FFA500',
            'scheduled': '#4A90E2',
            'in_progress': '#FFD700',
            'completed': '#28A745',
            'cancelled': '#DC3545'
        };
        return `<span class="status-badge" style="background-color: ${colors[status]}; color: white;">${statusDisplay}</span>`;
    }
    
    // Function to load appointments
    function loadAppointments() {
        const statusFilter = document.getElementById('statusFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;
        
        // Show loading overlay
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        // Build query parameters
        let url = '{% url "core:api_map_appointments" %}?';
        if (statusFilter) url += `status=${statusFilter}&`;
        if (dateFilter) url += `date=${dateFilter}&`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                // Clear existing markers
                markerGroup.clearLayers();
                markers = [];
                
                // Add new markers
                data.appointments.forEach(apt => {
                    const icon = createCustomIcon(apt.marker_color);
                    const marker = L.marker([apt.latitude, apt.longitude], { icon: icon });
                    
                    // Create popup content
                    const popupContent = `
                        <div class="popup-content">
                            <div class="popup-header">${apt.address}</div>
                            <div class="popup-detail">
                                <i class="fas fa-user"></i>
                                <span>${apt.customer_name}</span>
                            </div>
                            <div class="popup-detail">
                                <i class="fas fa-trash"></i>
                                <span>${apt.waste_type}</span>
                            </div>
                            <div class="popup-detail">
                                <i class="fas fa-calendar"></i>
                                <span>${apt.preferred_date} at ${apt.preferred_time}</span>
                            </div>
                            <div class="popup-detail">
                                <i class="fas fa-flag"></i>
                                <span>${apt.priority_display}</span>
                            </div>
                            ${apt.estimated_weight ? `
                            <div class="popup-detail">
                                <i class="fas fa-weight"></i>
                                <span>${apt.estimated_weight} kg</span>
                            </div>
                            ` : ''}
                            <div class="popup-detail">
                                <i class="fas fa-info-circle"></i>
                                ${getStatusBadge(apt.status, apt.status_display)}
                            </div>
                            ${apt.notes ? `
                            <div class="popup-detail mt-2">
                                <i class="fas fa-sticky-note"></i>
                                <span style="font-style: italic;">${apt.notes}</span>
                            </div>
                            ` : ''}
                            <div class="mt-3">
                                <a href="/appointments/${apt.id}/" class="btn btn-sm btn-primary w-100">
                                    <i class="fas fa-eye me-1"></i>View Details
                                </a>
                            </div>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent, {
                        maxWidth: 300,
                        className: 'custom-popup'
                    });
                    
                    markerGroup.addLayer(marker);
                    markers.push(marker);
                });
                
                // Update stats
                document.getElementById('totalMarkers').textContent = data.total;
                
                // Fit map to markers if any exist, but stay within Almeria bounds
                if (markers.length > 0) {
                    const group = new L.featureGroup(markers);
                    const bounds = group.getBounds();
                    // Only zoom to markers if they're within Almeria bounds
                    if (almeriaBounds.contains(bounds)) {
                        map.fitBounds(bounds.pad(0.1));
                    } else {
                        // Reset to Almeria center if markers are outside bounds
                        map.setView([11.6447, 124.3931], 14);
                    }
                } else {
                    // Reset to Almeria center if no locations found
                    map.setView([11.6447, 124.3931], 14);
                }
                
                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';
            })
            .catch(error => {
                console.error('Error loading appointments:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('Error loading map data. Please try again.');
            });
    }
    
    // Event listeners
    document.getElementById('applyFilters').addEventListener('click', loadAppointments);
    document.getElementById('clearFilters').addEventListener('click', function() {
        document.getElementById('statusFilter').value = '';
        document.getElementById('dateFilter').value = '';
        loadAppointments();
    });
    
    // Load appointments on page load
    loadAppointments();
    
    // Add click event to map for adding new locations (optional feature)
    map.on('click', function(e) {
        console.log('Clicked coordinates:', e.latlng);
        // You can use this to help users add coordinates to their appointments
    });
    
    } catch (error) {
        console.error('Error initializing map:', error);
        document.getElementById('map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; padding: 2rem; text-align: center;"><i class="fas fa-times-circle fa-3x text-danger mb-3"></i><h4>Map Initialization Error</h4><p class="text-muted">Error: ' + error.message + '</p><button class="btn btn-primary mt-3" onclick="location.reload()"><i class="fas fa-sync me-2"></i>Reload Page</button></div>';
    }
});
</script>
{% endblock %}
