{% extends "base.html" %}
{% load static %}

{% block title %}Appointment Calendar - Waste Care{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="mb-1">
                <i class="fas fa-calendar-alt me-2 text-primary"></i>
                Appointment Calendar
            </h2>
            <p class="text-muted mb-0">Manage and view all pickup appointments</p>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
                <a href="{% url 'core:smart_scheduling' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>New Appointment
                </a>
                <button type="button" class="btn btn-outline-primary" onclick="refreshCalendar()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Calendar Controls -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body p-3">
                    <h6 class="card-title mb-2">
                        <i class="fas fa-filter me-2"></i>Filters
                    </h6>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <select class="form-select form-select-sm" id="statusFilter">
                                <option value="">All Statuses</option>
                                <option value="requested">Requested</option>
                                <option value="scheduled">Scheduled</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select form-select-sm" id="wasteTypeFilter">
                                <option value="">All Waste Types</option>
                                <option value="general">General Waste</option>
                                <option value="recyclable">Recyclable</option>
                                <option value="organic">Organic</option>
                                <option value="hazardous">Hazardous</option>
                                <option value="bulk">Bulk Items</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body p-3">
                    <h6 class="card-title mb-2">
                        <i class="fas fa-palette me-2"></i>Legend
                    </h6>
                    <div class="d-flex flex-wrap gap-3">
                        <div class="d-flex align-items-center">
                            <div class="legend-color bg-warning me-2"></div>
                            <small>Requested</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="legend-color bg-info me-2"></div>
                            <small>Scheduled</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="legend-color bg-primary me-2"></div>
                            <small>In Progress</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="legend-color bg-success me-2"></div>
                            <small>Completed</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="legend-color bg-danger me-2"></div>
                            <small>Cancelled</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Appointment Details Modal -->
<div class="modal fade" id="appointmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-check me-2"></i>
                    Appointment Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="appointmentDetails">
                    <!-- Appointment details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <div id="appointmentActions">
                    <!-- Action buttons will be added here based on user role and appointment status -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Status Update Modal -->
<div class="modal fade" id="statusUpdateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="statusUpdateForm">
                    <div class="mb-3">
                        <label class="form-label">New Status</label>
                        <select class="form-select" id="newStatus" required>
                            <option value="">Select Status</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="statusNotes" rows="3" placeholder="Add any notes about this status change..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateAppointmentStatus()">Update Status</button>
            </div>
        </div>
    </div>
</div>

<style>
.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 3px;
    display: inline-block;
}

#calendar {
    height: 600px;
}

.fc-event {
    border: none !important;
    font-size: 0.85em;
}

.fc-event-title {
    font-weight: 500;
}

.fc-daygrid-event {
    margin: 1px 0;
    padding: 2px 4px;
}

.fc-toolbar-title {
    font-size: 1.5em !important;
    font-weight: 600;
}

.fc-button-primary {
    background-color: #6366f1 !important;
    border-color: #6366f1 !important;
}

.fc-button-primary:hover {
    background-color: #4f46e5 !important;
    border-color: #4f46e5 !important;
}

.appointment-detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.appointment-detail-item:last-child {
    border-bottom: none;
}

.status-badge {
    font-size: 0.8em;
    padding: 4px 8px;
}
</style>

<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css' rel='stylesheet' />

<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js'></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: {% if calendar_events %}{{ calendar_events|safe }}{% else %}[]{% endif %},
        eventClick: function(info) {
            showAppointmentDetails(info.event);
        },
        eventDidMount: function(info) {
            // Add tooltip
            info.el.setAttribute('title', 
                `${info.event.extendedProps.waste_type} - ${info.event.extendedProps.status}`
            );
        },
        height: 'auto',
        eventDisplay: 'block',
        dayMaxEvents: 3,
        moreLinkClick: 'popover'
    });
    
    calendar.render();
    
    // Filter functionality
    document.getElementById('statusFilter').addEventListener('change', filterCalendar);
    document.getElementById('wasteTypeFilter').addEventListener('change', filterCalendar);
    
    function filterCalendar() {
        const statusFilter = document.getElementById('statusFilter').value;
        const wasteTypeFilter = document.getElementById('wasteTypeFilter').value;
        
        const events = {% if calendar_events %}{{ calendar_events|safe }}{% else %}[]{% endif %};
        let filteredEvents = events;
        
        if (statusFilter) {
            filteredEvents = filteredEvents.filter(event => event.status === statusFilter);
        }
        
        if (wasteTypeFilter) {
            filteredEvents = filteredEvents.filter(event => event.waste_type === wasteTypeFilter);
        }
        
        calendar.removeAllEvents();
        calendar.addEventSource(filteredEvents);
    }
    
    window.refreshCalendar = function() {
        location.reload();
    };
});

let currentAppointmentId = null;

function showAppointmentDetails(event) {
    currentAppointmentId = event.id;
    
    // Fetch detailed appointment information
    fetch(`/api/appointments/${event.id}/`)
        .then(response => response.json())
        .then(data => {
            const detailsHtml = `
                <div class="appointment-detail-item">
                    <strong>Customer:</strong>
                    <span>${data.customer_name}</span>
                </div>
                <div class="appointment-detail-item">
                    <strong>Waste Type:</strong>
                    <span class="badge bg-secondary">${data.waste_type}</span>
                </div>
                <div class="appointment-detail-item">
                    <strong>Status:</strong>
                    <span class="badge status-badge bg-${getStatusColor(data.status)}">${data.status_display}</span>
                </div>
                <div class="appointment-detail-item">
                    <strong>Date & Time:</strong>
                    <span>${data.preferred_date} at ${data.preferred_time}</span>
                </div>
                <div class="appointment-detail-item">
                    <strong>Address:</strong>
                    <span>${data.address}</span>
                </div>
                <div class="appointment-detail-item">
                    <strong>Priority:</strong>
                    <span class="badge bg-${getPriorityColor(data.priority)}">${data.priority}</span>
                </div>
                ${data.estimated_weight ? `
                <div class="appointment-detail-item">
                    <strong>Estimated Weight:</strong>
                    <span>${data.estimated_weight} kg</span>
                </div>
                ` : ''}
                ${data.notes ? `
                <div class="appointment-detail-item">
                    <strong>Notes:</strong>
                    <span>${data.notes}</span>
                </div>
                ` : ''}
                ${data.special_instructions ? `
                <div class="appointment-detail-item">
                    <strong>Special Instructions:</strong>
                    <span>${data.special_instructions}</span>
                </div>
                ` : ''}
            `;
            
            document.getElementById('appointmentDetails').innerHTML = detailsHtml;
            
            // Add action buttons based on user role and appointment status
            const actionsHtml = getActionButtons(data);
            document.getElementById('appointmentActions').innerHTML = actionsHtml;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('appointmentModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error fetching appointment details:', error);
            alert('Error loading appointment details');
        });
}

function getStatusColor(status) {
    const colors = {
        'requested': 'warning',
        'scheduled': 'info',
        'in_progress': 'primary',
        'completed': 'success',
        'cancelled': 'danger'
    };
    return colors[status] || 'secondary';
}

function getPriorityColor(priority) {
    const colors = {
        'low': 'success',
        'normal': 'info',
        'high': 'warning',
        'urgent': 'danger'
    };
    return colors[priority] || 'secondary';
}

function getActionButtons(appointment) {
    let buttons = '';
    
    // Edit button (for customers on their own appointments or staff/admin)
    const userRole = '{{ user.role }}';
    if (userRole === 'customer' || userRole === 'staff' || userRole === 'admin') {
        buttons += `<a href="/appointments/${appointment.id}/edit/" class="btn btn-outline-primary me-2">
            <i class="fas fa-edit me-1"></i>Edit
        </a>`;
    }
    
    // Status update button (for staff/admin or drivers)
    if (userRole === 'staff' || userRole === 'admin' || userRole === 'driver') {
        buttons += `<button type="button" class="btn btn-primary me-2" onclick="showStatusUpdateModal()">
            <i class="fas fa-sync-alt me-1"></i>Update Status
        </button>`;
    }
    
    return buttons;
}

function showStatusUpdateModal() {
    const modal = new bootstrap.Modal(document.getElementById('statusUpdateModal'));
    modal.show();
}

function updateAppointmentStatus() {
    const newStatus = document.getElementById('newStatus').value;
    const notes = document.getElementById('statusNotes').value;
    
    if (!newStatus) {
        alert('Please select a status');
        return;
    }
    
    fetch(`/api/appointments/${currentAppointmentId}/update-status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            status: newStatus,
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Close modals
            bootstrap.Modal.getInstance(document.getElementById('statusUpdateModal')).hide();
            bootstrap.Modal.getInstance(document.getElementById('appointmentModal')).hide();
            
            // Refresh calendar
            location.reload();
        } else {
            alert('Error updating status: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error updating status:', error);
        alert('Error updating status');
    });
}
</script>
{% endblock %}
